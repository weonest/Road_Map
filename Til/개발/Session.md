# Session

------

## HTTP의 비연결성과 비상태성

HTTP는 요청과 응답을 한 번 주고받으면 바로 연결을 끊어버리는 특성을 가지고 있다. 그리고 다음 요청을 하기 위해 다시 연결을 맺어야 한다. 이를 http의 비연결성(connectionless)라고 한다.

또한, http 프로토콜은 요청과 응답을 교환하는 동안 상태를 저장하지 않는다. 따라서 http 레벨에서는 이전에 보냈던 리퀘스트나 리스폰스를 기억하지 못한다. 즉, http 요청은 직전의 요청과 전혀 관련이 없다. 이를 http의 비상태성(stateless) 라고 한다.

http가 상태를 갖지 않음으로써 연결을 맺을 때 발생하는 오버헤드가 줄어들고, 데이터를 빠르고 확실하게 처리할 수 있다고 한다. 또한 요청간의 상태를 공유하지 않으므로 확장성을 갖는다고 한다. 왜 이러한 특징을 갖을까?

처음 http가 등장할 때에는 단순히 html 문서만을 주고 받는 것이 목적의 전부였기 때문에, 최대한 단순하게 설계되었기 때문이다

하지만 웹이 발전하면서 요청과 요청간의 상태가 유지되어야 할 필요가 있어졌다. 상태가 유지되지 않으면, 사용자는 페이지를 이동할 때마다 새롭게 로그인을 해줘야할 것이기 때문이다

### 쿠키 (Cookie)

![https://hudi.blog/static/5a4ced996d1359318192025e6cc2c655/8b7fc/cookie.png](https://hudi.blog/static/5a4ced996d1359318192025e6cc2c655/8b7fc/cookie.png)

이런 http의 비상태성을 보완하기 위해 등장한 것이 쿠키이다. 쿠키는 http 요청과 응답에 함께 실려 전송된다. 쿠키는 클라이언트 즉, 브라우저에 저장된다. 웹 서버가 클라이언트로 보내는 응답의 헤더 중 Set-Cookie 라는 헤더에 키와 값을 함께 실어 보내면 그 응답을 받은 브라우저는 해당 쿠키를 저장하고, 그 다음 요청부터 자동으로 쿠키를 헤더에 넣어 송신한다.

### 쿠키의 문제점

앞서 말했듯 쿠키는 한 번 생성되면 매 요청마다 헤더에 실려 서버로 전송된다. 만약 쿠키에 저장된 정보가 많다면, 매 요청마다 큰 오버헤드가 발생할 것이다. 이런 이유로 브라우저마다 다르겠지만, 일반적으로 쿠키의 데이터는 4kb로 제한이 되어있다. 또한 인터넷 익스플로러를 제외하고는 사이트 당 쿠키의 갯수도 20개로 제한이 되어있다고 한다.

이런 성능이슈와 더불어 보안이슈도 존재한다. 쿠키는 위에서 얘기했듯 클라이언트 측에 저장된다. 만료시각을 명시하지 않으면 쿠키는 메모리에 저장되어 브라우저를 종료하면 휘발되지만, 만료시각을 명시하면 파일로 저장되어 브라우저가 종료되더라도 휘발되지 않는다. 만약 민감한 정보를 가지고 있는 쿠기가 파일의 형태로 있다면 해커에게 탈취되기 쉬울 것이다.

## Session이란?

세션이란 일정 시간동안 같은 사용자(정확하게는 브라우저)로 부터 들어오는 일련의 요구를 하나의 상태로 보고 그 상태를 일정하게 유지시키는 기술이다.

또한, 여기서 일정 시간이란 방문자가 웹 브라우저를 통해 웹 서버에 접속한 시점으로부터 웹 브라우저를 종료함으로써 연결을 끝내는 시점을 말한다.

즉, 방문자가 웹 서버에 접속해 있는 상태를 하나의 단위로 보고 세션이라고 칭한다.

그렇다면 이 세션이라는 것은 어떻게 비상태성을 갖는 http에서 상태를 일정하게 유지할까?

### 세션 생성 과정

맨 처음, 사용자가 http 요청의 Body에 인증 정보를 실어 서버로 보낸다. 서버에서는 해당 인증정보가 유효하면 사용자와 데이터를 식별하는 `Session ID` 를 생성한다. 생성된 Session ID는 응답의 Set-Cookie 헤더에 생성된 세션 아이디를 실어 보내진다.

클라이언트는 해당 세션 아이디를 쿠키에 저장하고, 매 요청마다 세션 아이디를 Cookie 헤더에 실어 전송한다. 서버는 전달받은 세션 아이디를 통해 해당 요청의 송신자가 누구인지 식별할 수 있다.

### 세션 정보는 어디에 저장될까?

일반적으로 생성된 세션 데이터는 서버의 메모리에 저장된다. 하지만 로드 밸런싱 등의 이유로 서버를 수평 확장 하는 경우가 많을 것이다. 이런 경우 최초 세션이 생성된 서버와 그 이후의 요청을 받은 서버가 다른 경우 세션이 불일치하는 문제가 발생할 것이다

이런 문제를 해결하기 위해 유저의 요청이 무조건 세션을 생성한 서버로 향하도록 하는 `Sticky Session`, 여러 웹서버가 모두 동일한 세션 정보를 가지고 있는 `Session Clustering` 방식이 있지만, 세션 정보를 관리하는 서버를 아예 별개로 두는 `**Session Storage**` 방식이 가장 많이 쓰인다고 한다.

이를 위해 MySQL 같은 일반적인 RDBMS를 사용할 수도 있겠지만, Key-Value로 저장되는 세션 특성상 Redis나 memcached 와 같은 Key-Value 쌍으로 저장되는 인메모리 스토어를 사용하는 것이 일반적이다.

### 쿠키 vs 세션

쿠키

- 쿠키의 경우 방문자의 정보를 방문자 컴퓨터의 메모리에 저장
- 예를 들자면 ID나 비밀번호를 저장하거나 방문한 사이트를 저장하는데에 사용

세션

- 방문자의 요청에 따른 정보를 방문자 메모리에 저장하는 것이 아닌 웹 서버가 세션 아이디 파일을 만들어 서비스가 돌아가고 있는 서버에 저장을 하는 것을 말한다

출처 : https://hudi.blog/cookie-and-session/