# 운영체제 1

------

## 운영체제란?

운영체제 (Operation System) 란 컴퓨터 시스템의 자원들을 효율적으로 관리하며, 사용자가 컴퓨터를 편리하고 효과적으로 사용할 수 있도록 환경을 제공하는 여러 프로그램의 모임이다.

## 프로세스와 스레드

### 1. 프로세스

프로세스란 일반적으로 CPU에 의해 처리되는 사용자 프로그램, 시스템 프로그램 즉 `실행중인 프로그램`을 의미하며, 작업, 태스크라고도 한다.

운영체제로부터 시스템 자원 (주소 공간, 파일, 메모리 등)을 할당받는 작업의 단위

### 프로세스와 프로그램

`프로그램`은 일반적으로 하드 디스크 등에 저장되어 있는 실행 코드를 뜻하고, `프로세스`는 **프로그램을 구동하여 프로그램 자체와 프로그램의 상태가 메모리 상에서 실행되는 작업단위를 지칭**한다.

프로세스와 프로그램의 차이는 프로그램 자체는 생명이 없다는 것. 프로그램은 보조 기억장치에 존재하며 실행되기를 기다리는 명령어와 정적인 데이터의 묶음이다. 이 프로그램의 명령어와 정적 데이터가 자원을 할당받고 메모리에 적재되면 프로세스가 된다.

> - 프로그램은 명령어를 내용으로 가진 디스크에 저장된 파일, 수동적인 존재
> - 프로세스는 다음에 실행할 명령어를 지정하는 프로그램 카운터 및 관련된 자원의 집합을 가진 능동적 존재
>
> 실행 파일이 메모리에 적재될 때 비로소 프로그램이 프로세스가 되는 것

프로세스는 완벽히 독립적이기 때문에 메모리 영역 (Code, Data, Heap, Stack)을 다른 프로세스와 공유를 하지 않지만, 쓰레드는 프로세스의 Code, Data, Heap을 공유한다.

### 2. 스레드

스레드란 어떠한 프로그램 내에서, 특히 프로세스 내에서 실행되는 흐름의 단위이다

- 스레드는 프로세스 내에서 각각 Stack만 따로 할당 받고 (독립 Stack 보유), Code, Data, Heap 영역은 공유한다.

  - 각각의 스레드는 독립적인 작업을 수행해야 하기 때문에 각자의 Stack과 PC Register를 가진다

  > 여기서의 PC Register는 Jvm 메모리 영역에서의 PC Register와 마찬가지로 명령어 수행 정보에 대한 임시 메모리 공간이다.

- 스레드는 한 프로세스 내에서 동작되는 여러 실행의 흐름으로, 프로세스 내의 주소 공간이나 자원들을 같은 프로세스 내에 스레드끼리 공유하면서 실행된다.

- 같은 프로세스 안에 있는 여러 스레드들은 같은 heap 공간을 공유한다. 반면에 프로세스는 다른 프로세스의 메모리에 직접 접근할 수 없다.

## 멀티 프로세스와 멀티 스레드

### 1. 멀티 프로세스

멀티 프로레스란 하나의 응용 프로그램을 여러 개의 프로세스로 구성하여 각 프로세스가 하나의 작업을 처리하도록 하는 것이다

### 장점

- 멀티 프로세싱은 여러 개의 자식 프로세스 중 하나에 문제가 발생해도 다른 프로세스들이 있기 때문에 영향이 확산되지 않는다.

### 단점

- Context Swithcing 과정에서 캐시 메모리 초기화 등 무거운 작업이 진행되고 많은 시간이 소모되는 등 오버헤드가 발생한다
- 프로세스는 각각 독립된 메모리 영역을 가지고 있기 때문에 프로세스 사이에서 공유하는 메모리는 없다. 따라서 Context Switching 이 발생하면 캐시에 있는 모든 데이터를 모두 리셋하고 다시 캐시 정보를 불러와야 한다.
- 독립된 영역 때문에 프로세스 간의 통신이 필요하다

### 2. 멀티 스레드

멀티 스레드는 하나의 프로그램을 여러 개의 스레드로 구성하는 방식이다

### 장점

- 멀티 스레드는 Stack을 제외한 자원들을 공유하고 있기 때문에 Context Switching 시에 캐시 메모리를 비울 필요가 없고 이를 통해서 리소스를 아낄 수 있다. → 자원들을 공유하고 있기 때문에 가상 메모리 공간을 바꿀 필요가 없다.
- Stack 이외의 메모리를 공유하고 있기 때문에 통신의 부담도 적다.

> Cache Memory
>
> 캐시 메모리는 CPU에서 한 번 이상 읽어 들인 메인 메모리의 데이터를 저장하고 있다가 CPU가 다시 그 메모리에 저장된 데이터를 요구할 때 메인 메모리를 통하지 않고 바로 값을 전달하는 용도로 사용된다.
>
> 프로세스 사이에서 공유하는 메모리가 하나도 없기 때문에 컨텍스트 스위칭이 발생하면 캐쉬에 있는 모든 데이터를 모두 리셋하고 다시 캐쉬 정보를 불러와야 한다.
>
> 쓰레드는 캐쉬 정보를 비울 필요가 없기 때문에 프로세스와 쓰레드의 컨텍스트 스위칭 속도의 차이는 이때 발생한다.

### 단점

- 내부의 메모리를 공유하고 있어서 한 프로세스의 스레드가 문제가 생기면 해당 프로세스 안의 다른 스레드에도 문제가 생긴다.
- 같은 데이터를 공유하기에 데이터 동기화에 신경을 써야 한다.

### 3. 멀티 프로세스 vs 멀티 스레드

멀티 스레드는 멀티 프로세스보다 적은 메모리 공간을 차지하고 Context Switching이 빠르다는 장점이 있지만, 오류로 인해서 하나의 스레드에 문제가 생기면 다른 스레드에도 문제가 생길 수 있다는 점과 동기화 문제를 가지고 있다. 반면에 멀티 프로세스는 하나의 프로세스가 문제가 생기더라도 다른 프로세스에는 영향을 끼치지 않는다는 장점이 있지만, 멀티 스레드보다 많은 메모리 공간과 CPU 시간을 차지한다는 단점이 있다.

이 두가지는 동시에 여러 작업을 수행한다는 점은 동일하지만, 적용해야 하는 시스템에 따라 잘 선택해야 한다.

## Context Switching

하나의 프로세스가 CPU를 사용중인 상태에서 다른 프로세스가 CPU를 사용하도록 하기 위해, 이전의 프로세스의 상태를 보관하고 새로운 프로세스의 상태를 적재하는 작업을 말한다. 한 프로세스의 문맥(상태)은 프로세스 제어 블록(PCB)에 기록되어 있다.

### 사용 이유

Computer Multitasking 을 통해 빠른 반응속도로 응답할 수 있다. 빠른 속도로 Task를 바꿔 가며 실행하기 때문에 사람의 눈으론 실시간처럼 보이게 되는 장점이 있다.

CPU가 Task를 바꿔 가며 실행하기 위해 Context Switching이 필요하게 되었다.

> PCB
>
> - 운영체제는 프로세스를 관리하기 위해 프로세스의 생성과 동시에 고유한 PCB를 생성
> - 프로세스는 CPU를 할당받아 작업을 처리하다가 프로세스의 전환이 발생하면 진행하던 작업을 저장하고 CPU를 반환, 이때의 모든 작업을 PCB에 저장
> - 다시 CPU를 할당받게 되면 PCB에 저장되어 있던 내용을 불러와 이전에 종료했던 시점(상태)부터 다시 작업을 수행

## PCB, TCB에 대한 정리

- Single Thread, Multi Process 환경

우선 PC Register는 CPU에 있다. 멀티프로세스 환경에서 Context Swtiching이 일어나면 현재까지 진행했던 process의 문맥을 어딘가에 저장해야 되기 때문에, PCB에 저장한다. PCB에 PC(Process Control) 값도 저장하게 된다. 그리고 CPU에 있는 PC (Program Counter) Register에는 새롭게 진행할 process의 PCB에 적혀있는 PC 값을 갖게 된다.

- Multi Thread, Multi Process 환경

PC 값을 PCB가 아닌 TCB (thread control block) 에 저장을 한다. 프로세스 A에 a, b, c 쓰레드가 있다고 생각해보자. a, b, c 쓰레드에 해당하는 정보를 저장해주는 a, b, c TCB는 A PCB에 연결이 되어 있다. PC 값을 PCB에 저장하지 않고, TCB에 각각 저장해둔다. 이 때도 TCB는 PC 값을 저장하고 있지만, PC Register는 CPU에 속해 있다. 또한 Context Switching이 일어날 때마다 TCB에 저장되어 있는 PC 값을 PC register에 저장을 하는 것

> 멀티 쓰레드 에서는 각각의 thread가 자신의 PC 값을 TCB에 저장한다. (multi thread 에서는 각각의 thread가 독립적인 pc 값을 가지고 있다). 그 이유는 한 process 내에서도 thread 사이에 context swtiching이 일어나는데, TCB에 code address(PC)가 저장되어 있어야 해당 쓰레드가 어느 코드 영역까지 진행했는지를 기억하여 그 다음 코드부터 실행을 할 수 있기 때문이다.
>
> 예를 들면, thread a에서 thread b로 context switching이 일어나면, 현재의 PC register 에 저장되어 있는 값을 thread a 의 TCB에 저장을 하고, thread b TCB의 PC 값을 불러와 PC register에 저장을 한다. CPU는 PC register가 새롭게 가리키는 thread b의 code 영역, 즉 thread b 내에서 다음에 실행해야 할 명령의 주소값 (PC)를 참조하여 실행을 하게 된다는 것